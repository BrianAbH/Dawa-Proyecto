<div class="crud-container">
  <h5 class="p-3">Reseñas<hr></h5>

  <!-- Tarjeta principal -->
  <div class="card m-3 mw-100">
    <div class="card-body row align-items-center">
      <div class="col-12 col-sm-10 mb-3 mb-sm-0">
        <h3 class="card-title">
          <i class="bi bi-chat-square-text me-2"></i>Gestión de Reseñas
        </h3>
        <h6 class="card-subtitle mb-2 text-body-secondary">
          Administra las reseñas de los usuarios ({{ resenas.length }} reseñas)
        </h6>
      </div>

      <div class="col-12 col-sm-2 text-sm-end">
        <button 
          class="b-style w-100 w-sm-auto mt-sm-2"
          (click)="prepararNuevaResena()"
          [disabled]="cargando"
        >
          <i class="bi bi-plus me-2 ms-4"></i>Nueva Reseña
        </button>
      </div>
    </div>
  </div>

 <!-- Barra de búsqueda y filtros en paralelo -->
<div class="card m-3">
  <div class="card-body p-2">
    <div class="d-flex flex-wrap align-items-center gap-2">
      
      <!-- Búsqueda -->
      <div class="flex-grow-1" style="min-width: 250px;">
        <div class="input-group input-group-sm">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="filtroBusqueda"
            placeholder="Buscar reseñas..."
            (keyup.enter)="aplicarBusqueda()"
          />
          <button 
            class="btn btn-primary"
            (click)="aplicarBusqueda()"
            [disabled]="cargando"
          >
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Filtro por calificación -->
      <div style="min-width: 180px;">
        <select 
          class="form-select form-select-sm"
          [(ngModel)]="filtroCalificacion" 
          (change)="aplicarFiltroCalificacion()"
        >
          <option [ngValue]="null">Todas las calificaciones</option>
          <option [value]="1">★ o más</option>
          <option [value]="2">★★ o más</option>
          <option [value]="3">★★★ o más</option>
          <option [value]="4">★★★★ o más</option>
          <option [value]="5">★★★★★</option>
        </select>
      </div>

      <!-- Botones de acciones -->
      <div class="btn-group" role="group">
        <button 
          class="btn btn-outline-secondary btn-sm"
          (click)="obtenerRecientes()"
          [disabled]="cargando"
          title="Ver reseñas recientes"
        >
          <i class="bi bi-clock"></i>
          <span class="d-none d-md-inline ms-1">Recientes</span>
        </button>
        <button 
          class="btn btn-outline-secondary btn-sm"
          (click)="obtenerPromedio()"
          [disabled]="cargando"
          title="Ver promedio de calificaciones"
        >
          <i class="bi bi-star-half"></i>
          <span class="d-none d-md-inline ms-1">Promedio</span>
        </button>
        <button 
          class="btn btn-outline-danger btn-sm"
          (click)="resetearFiltros()"
          [disabled]="cargando"
          title="Resetear filtros"
        >
          <i class="bi bi-arrow-counterclockwise"></i>
          <span class="d-none d-md-inline ms-1">Resetear</span>
        </button>
      </div>

    </div>
  </div>
</div>

  <!-- Tabla de reseñas -->
  <div class="card m-3 p-3">
    <div *ngIf="cargando" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando reseñas...</p>
    </div>

    <div *ngIf="!cargando">
      <table class="table table-hover table-sm">
        <thead class="table-light">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Título</th>
            <th scope="col">Contenido</th>
            <th scope="col">Calificación</th>
            <th scope="col">Fecha</th>
            <th scope="col">Solicitud ID</th>
            <th scope="col">Usuario</th>
            <th scope="col" class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let resena of resenas">
            <td class="fw-bold">{{ resena.id }}</td>
            <td>{{ resena.titulo }}</td>
            <td>
              {{ resena.contenido | slice:0:50 }}
              {{ resena.contenido.length > 50 ? '...' : '' }}
            </td>
            <td>
              <div class="d-flex align-items-center">
                <span class="text-warning me-1">
                  {{ getEstrellas(resena.calificacion).join('') }}
                </span>
                <span class="badge bg-light text-dark">
                  {{ resena.calificacion }}/5
                </span>
              </div>
            </td>
            <td>{{ resena.fecha | date:'dd/MM/yyyy' }}</td>
            <td>
              <span class="badge bg-info">{{ resena.solicitud_id }}</span>
            </td>
            <td>
              {{ resena.nombreUsuario || 'Anónimo' }}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button 
                  type="button" 
                  class="btn btn-outline-primary"
                  (click)="edit(resena)"
                  title="Editar"
                >
                  <i class="bi bi-pen"></i>
                </button>
                <button 
                  type="button" 
                  class="btn btn-outline-danger ms-1"
                  (click)="delete(resena)"
                  title="Eliminar"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="resenas.length === 0">
            <td colspan="8" class="text-center py-4">
              <div class="text-muted">
                <i class="bi bi-chat-square-text display-6"></i>
                <p class="mt-2">No hay reseñas para mostrar</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Formulario de creación/edición -->
  <div *ngIf="nuevaResena.titulo !== undefined" class="card m-3">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi" [class.bi-pencil-square]="modoEdicion" [class.bi-plus-circle]="!modoEdicion"></i>
        {{ modoEdicion ? 'Editar Reseña' : 'Nueva Reseña' }}
      </h5>
    </div>
    
    <div class="card-body">
      <form (ngSubmit)="modoEdicion ? update() : create()" #resenaForm="ngForm">
        <div class="row g-3">
          <!-- Título -->
          <div class="col-12 col-md-8">
            <label for="titulo" class="form-label">Título *</label>
            <input
              type="text"
              class="form-control"
              id="titulo"
              name="titulo"
              [(ngModel)]="nuevaResena.titulo"
              required
              maxlength="100"
              placeholder="Ingrese el título de la reseña"
            />
          </div>

          <!-- Calificación -->
          <div class="col-12 col-md-4">
            <label for="calificacion" class="form-label">Calificación *</label>
            <select
              class="form-select"
              id="calificacion"
              name="calificacion"
              [(ngModel)]="nuevaResena.calificacion"
              required
            >
              <option value="" disabled selected>Seleccione calificación</option>
              <option value="1">1 ★</option>
              <option value="2">2 ★★</option>
              <option value="3">3 ★★★</option>
              <option value="4">4 ★★★★</option>
              <option value="5">5 ★★★★★</option>
            </select>
          </div>

          <!-- Contenido -->
          <div class="col-12">
            <label for="contenido" class="form-label">Contenido *</label>
            <textarea
              class="form-control"
              id="contenido"
              name="contenido"
              [(ngModel)]="nuevaResena.contenido"
              required
              rows="4"
              maxlength="500"
              placeholder="Escriba el contenido de la reseña..."
            ></textarea>
            <div class="form-text">
              Máximo 500 caracteres ({{ nuevaResena.contenido?.length || 0 }}/500)
            </div>
          </div>

          <!-- Solicitud ID -->
          <div class="col-12 col-md-4">
            <label for="solicitud_id" class="form-label">ID Solicitud *</label>
            <input
              type="text"
              class="form-control"
              id="solicitud_id"
              name="solicitud_id"
              [(ngModel)]="nuevaResena.solicitud_id"
              required
              placeholder="Ej: SOL-001"
            />
          </div>

          <!-- Nombre Usuario -->
          <div class="col-12 col-md-4">
            <label for="nombreUsuario" class="form-label">Nombre Usuario (opcional)</label>
            <input
              type="text"
              class="form-control"
              id="nombreUsuario"
              name="nombreUsuario"
              [(ngModel)]="nuevaResena.nombreUsuario"
              maxlength="50"
              placeholder="Nombre del usuario"
            />
          </div>

          <!-- Fecha -->
          <div class="col-12 col-md-4">
            <label for="fecha" class="form-label">Fecha</label>
            <input
              type="date"
              class="form-control"
              id="fecha"
              name="fecha"
              [(ngModel)]="nuevaResena.fecha"
            />
          </div>
        </div>

        <!-- Botones del formulario -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="cancelar()" 
            [disabled]="cargando"
          >
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="!resenaForm.form.valid || cargando"
          >
            <span *ngIf="cargando" class="spinner-border spinner-border-sm me-2"></span>
            <i class="bi" [class.bi-check-circle]="!cargando" [class.bi-arrow-repeat]="cargando"></i>
            {{ modoEdicion ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>